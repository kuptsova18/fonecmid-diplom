
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	Если ВКМ_Договор.ВидДоговора <> Перечисления.ВидыДоговоровКонтрагентов.ВКМ_АбонентскоеОбслуживание Тогда
		Сообщить("Вид договора не является 'Абоненское обслуживание'");
		отказ = истина;
	КонецЕсли;
	
	Если (Дата <= ВКМ_Договор.ВКМ_ДатаНачалаДействия и Дата>=ВКМ_Договор.ВКМ_ДатаОкончанияДействия) Тогда
		Сообщить("Дата документа выходит за рамки периода действия договора");	
		отказ = истина;
	КонецЕсли; 
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВКМ_УсловияОплатыСотрудниковСрезПоследних.Сотрудник КАК Сотрудник,
		|	ЕСТЬNULL(ВКМ_УсловияОплатыСотрудниковСрезПоследних.ПроцентОтРабот, 0) КАК ПроцентОтРабот
		|ИЗ
		|	РегистрСведений.ВКМ_УсловияОплатыСотрудников.СрезПоследних(&Период, Сотрудник = &Сотрудник) КАК ВКМ_УсловияОплатыСотрудниковСрезПоследних";
	
	Запрос.УстановитьПараметр("Период", Дата);
	Запрос.УстановитьПараметр("Сотрудник", ВКМ_Специалист);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если не ВыборкаДетальныеЗаписи.Следующий() Тогда
		Сообщить("Специалисту на дату документа не установлен процент от работ");	
		отказ = истина;	 
	Иначе   
		ПроцентОтРабот = ВыборкаДетальныеЗаписи.ПроцентОтРабот;
	КонецЕсли;

	Если (Дата <= ВКМ_Договор.ВКМ_ДатаНачалаДействия и Дата>=ВКМ_Договор.ВКМ_ДатаОкончанияДействия) Тогда
		Сообщить("Дата документа выходит за рамки периода действия договора");	
		отказ = истина;  
	КонецЕсли; 
	
	СтавкаЧасаДоговора = ВКМ_Договор.ВКМ_СтоимостьЧаса; 
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Записывать = Истина; 
	Для каждого стр из ВКМ_ВыполненныеРаботы Цикл
		Движение = Движения.ВКМ_ВыполненныеКлиентуРаботы.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период = Дата;
		Движение.ВКМ_Договор = ВКМ_Договор;
		Движение.ВКМ_Клиент = ВКМ_Клиент;
		Движение.ВКМ_КоличествоЧасов = стр.ВКМ_ЧасыКОплате;
		Движение.ВКМ_СуммаКОплате = стр.ВКМ_ЧасыКОплате * СтавкаЧасаДоговора; 
	КонецЦикла;

	Движения.ВКМ_ВыполненныеСотрудникомРаботы.Записывать = истина;
	
	ЧасовКОплатеКлиенту = ВКМ_ВыполненныеРаботы.Итог("ВКМ_ЧасыКОплате"); 
	СтавкаЧасаКлиента = ВКМ_Договор.ВКМ_СтоимостьЧаса;
	
	Движение = Движения.ВКМ_ВыполненныеСотрудникомРаботы.Добавить();
	Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
	Движение.Период = Дата;	
	Движение.Сотрудник = ВКМ_Специалист;	 
	Движение.ЧасовКОплате = ЧасовКОплатеКлиенту;
	Движение.СуммаКОплате = ЧасовКОплатеКлиенту * СтавкаЧасаКлиента * ПроцентОтРабот / 100;	
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	ТекстСообщения = ""; 
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ССылка, 
	"ВКМ_ВремяНачалаРабот, ВКМ_ДатаПроведенияРабот, ВКМ_ВремяОкончанияРабот, ВКМ_Специалист");

	Если ЭтоНовый() Тогда
		ТекстСообщения = СТрШаблон("Документ записывается первый раз. Запланированная дата: %1. Специалист: %2",
		ЭтотОбъект.ВКМ_ДатаПроведенияРабот, ЭтотОбъект.ВКМ_Специалист); 
		
	ИначеЕсли ЭтотОбъект.ВКМ_ВремяНачалаРабот <> ЗначенияРеквизитов.ВКМ_ВремяНачалаРабот Тогда
		ТекстСообщения = СТРШаблон("Время начала работ изменилась изменилась на %1 в документе %2",
		Формат(ЭтотОбъект.ВКМ_ВремяНачалаРабот,"ДЛФ=В"), ЭтотОбъект.Ссылка); 
		
	ИначеЕсли ЭтотОбъект.ВКМ_ВремяОкончанияРабот <> ЗначенияРеквизитов.ВКМ_ВремяОкончанияРабот  Тогда
		ТекстСообщения = СТРШаблон("Время окончания работ изменилась изменилась %1 в документе %2",
		Формат(ЭтотОбъект.ВКМ_ВремяОкончанияРабот,"ДЛФ=В"),ЭтотОбъект.Ссылка);
		
	ИначеЕсли ЭтотОбъект.ВКМ_ДатаПроведенияРабот <> ЗначенияРеквизитов.ВКМ_ДатаПроведенияРабот Тогда 
		ТекстСообщения = СТРШаблон("Дата проверения работ изменилась %1 в документе %2",
		Формат(ЭтотОбъект.ВКМ_ДатаПроведенияРабот,"ДЛФ=В"),ЭтотОбъект.Ссылка); 
		
	ИначеЕсли ЭтотОбъект.ВКМ_Специалист <> ЗначенияРеквизитов.ВКМ_Специалист Тогда
		ТекстСообщения = СТРШаблон("Специалист изменился на %1 в документе %2",
		ЭтотОбъект.ВКМ_Специалист,ЭтотОбъект.Ссылка);
	КонецЕсли; 
	
	Если ТекстСообщения <> "" Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = ТекстСообщения; 
		Сообщение.Сообщить();   
		НовоеУведомление = Справочники.ВКМ_УведомленияТелеграмБоту.СоздатьЭлемент();
		НовоеУведомление.ВКМ_Текст = ТекстСообщения;   
		НовоеУведомление.Записать();
	КонецЕсли;
КонецПроцедуры
